#
# To build your layer.zip file for AWS Lambda, run the following commands:
#

# docker build -f layout-dockerfile -t layer .  
# docker images 
# docker run  -it --rm -v <absolute host path>:/download <image ID> (example: docker run  -it --rm -v /Users/aref/Downloads:/download 4c32df90a1d5)
# in the container:
#   cd /
#   cd layer/
#   cp layer.zip /download/


FROM amazonlinux:2
WORKDIR /App

RUN yum update -y

RUN yum groupinstall "Development Tools" -y
RUN yum erase openssl-devel -y
RUN yum install openssl11 openssl11-devel  libffi-devel bzip2-devel wget -y

RUN yum install wget -y
RUN yum install zip -y

RUN wget https://www.python.org/ftp/python/3.12.0/Python-3.12.0.tgz
RUN tar -xf Python-3.12.0.tgz
RUN cd Python-3.12.0 && \
    bash ./configure --enable-optimizations && \
    make -j $(nproc) && \
    make altinstall 

RUN python --version

RUN yum install python3-pip -y

RUN cd / && \
    mkdir layer && \
    cd layer && \
    mkdir python

# Install python packages below
RUN cd /layer/python/ && \
pip3 install python-multipart -t .  && \
pip3 install PyJWT -t . && \
pip3 install cffi -t . && \
pip3 install dynamodb_json -t . &&\
pip3 install cryptography -t . && \ 
pip3 install elasticsearch -t .

# End installing python packages below

RUN cd /layer/ && \
    zip -r layer.zip .

RUN cd /
